<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Notd* - Test</title>
    <link rel="stylesheet" href="src/styles.css" />
    <link rel="stylesheet" href="src/edit.css" />
</head>

<body>
    <div id="header">
        <div id="header-top">
            <div id="header-buttons">
                <button id="load-json-btn">LOAD JSON</button>
                <button id="ai-enter-btn">ENTER</button>
                <button id="save-btn-header">SAVE</button>
                <button id="edit-btn">EDIT</button>
                <input type="file" id="load-file" accept=".json" style="display: none" />
            </div>
            <div id="header-title">NOTD* TEST</div>
        </div>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search entries..."
                style="width: 160px !important; max-width: 160px !important;" />
            <button id="search-clear">Clear</button>
            <button id="ai-btn"
                style="background-color: #555; color: white; border: 1px solid #777; padding: 6px 14px; cursor: pointer; font-family: monospace; font-size: 13px; height: 32px;">AI</button>
            <span id="search-results"></span>
        </div>
    </div>

    <div id="content">
        <div id="welcome-message" style="padding: 40px; text-align: center; color: #aaa">
            <div id="welcome-title"></div>
            <div style="font-size: 12px; color: #666">
                NOTD* TEST<br />
                Click LOAD JSON to load test data
            </div>
        </div>

        <div id="entries-container"></div>
        <div id="footer">
            <a href="#" id="notd-toggle-link" style="color: #FF5100; text-decoration: none; font-size: 11px">NOTD*</a>
            <span style="color: #888; font-size: 11px">&nbsp;&nbsp;2.3.0-test</span>
            <span style="margin: 0 5px">Â·</span>
            <a href="#" id="api-settings-link" style="color: #888; text-decoration: none; font-size: 11px">API</a>
        </div>
    </div>

    <!-- Floating form overlay -->
    <div id="form-overlay"></div>

    <!-- AI Analysis Result Modal -->
    <div id="ai-analysis-modal"
        style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #444; padding: 20px; border: 1px solid #666; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); z-index: 1001; min-width: 400px; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <h2 style="color: #FF5100; font-size: 18px; margin-top: 0; margin-bottom: 15px;">AI Analysis Results</h2>
        <div id="ai-analysis-content"
            style="background-color: #3a3a3a; padding: 15px; border: 1px solid #555; border-radius: 4px; white-space: pre-wrap; line-height: 1.6;">
        </div>
        <button id="ai-analysis-close"
            style="margin-top: 15px; background-color: #555; color: white; border: 1px solid #777; padding: 6px 14px; cursor: pointer; font-family: monospace; font-size: 13px; height: 32px;">CLOSE</button>
    </div>

    <!-- AI Entry Form -->
    <div id="ai-entry-form" style="display: none">
        <div class="form-group">
            <label for="ai-date-input">Date:</label>
            <input type="text" id="ai-date-input" readonly />
        </div>
        <div class="form-group">
            <label for="ai-time-input">Time:</label>
            <input type="text" id="ai-time-input" readonly />
        </div>
        <div class="form-group">
            <label for="ai-text-input">Text:</label>
            <textarea id="ai-text-input"
                placeholder="Describe your entry in natural language...&#10;e.g., 'Had coffee at Starbucks downtown, discussed the new project with Sarah'"
                style="
                        width: 100%;
                        max-width: 400px;
                        height: 80px;
                        background-color: #555;
                        color: white;
                        border: 1px solid #777;
                        padding: 8px;
                        font-family: monospace;
                        font-size: 14px;
                        resize: vertical;
                    "></textarea>
        </div>
        <div style="
                    margin-top: 10px;
                    display: flex;
                    gap: 10px;
                    flex-wrap: wrap;
                ">
            <button id="ai-process-btn" style="
                        background-color: #555;
                        color: white;
                        border: 1px solid #777;
                        padding: 6px 14px;
                        cursor: pointer;
                        font-family: monospace;
                        font-size: 13px;
                        height: 32px;
                    ">
                PROCESS
            </button>
            <button id="ai-save-btn" style="
                        display: none;
                        background-color: #FF5100;
                        color: white;
                        border: 1px solid #FF5100;
                        padding: 6px 14px;
                        cursor: pointer;
                        font-family: monospace;
                        font-size: 13px;
                        height: 32px;
                    ">
                SAVE
            </button>
        </div>
        <div id="ai-preview" style="
                    display: none;
                    margin-top: 15px;
                    padding: 10px;
                    background-color: #3a3a3a;
                    border: 1px solid #555;
                    border-radius: 4px;
                "></div>
    </div>

    <script src="src/edit.js"></script>
    <script src="src/llm.js"></script>
    <script src="src/swipe-delete.js"></script>
    <script src="src/diary.js?t=20250126f"></script>
    <script>
        // JSON loading functionality
        document.getElementById('load-json-btn').addEventListener('click', function () {
            document.getElementById('load-file').click();
        });

        // Override the file input handler to load JSON
        const fileInput = document.getElementById('load-file');
        fileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                try {
                    const jsonData = JSON.parse(event.target.result);
                    console.log('Loaded JSON data:', jsonData);

                    // Store in localStorage if diary.js expects it there
                    if (jsonData.entries) {
                        localStorage.setItem('diaryEntries', JSON.stringify(jsonData.entries));
                    } else {
                        localStorage.setItem('diaryEntries', JSON.stringify(jsonData));
                    }

                    // Reload the page to refresh the entries
                    location.reload();
                } catch (error) {
                    console.error('Error parsing JSON:', error);
                    alert('Error loading JSON file: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        // AI Analysis modal close functionality
        document.getElementById('ai-analysis-close').addEventListener('click', function () {
            document.getElementById('ai-analysis-modal').style.display = 'none';
            document.getElementById('form-overlay').style.display = 'none';
        });

        // Close modal when clicking overlay
        document.getElementById('form-overlay').addEventListener('click', function () {
            const modal = document.getElementById('ai-analysis-modal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
                this.style.display = 'none';
            }
        });

        // AI Analysis functionality
        document.getElementById('ai-btn').addEventListener('click', async function () {
            // Get API key from localStorage
            const apiKey = localStorage.getItem('groq_api_key');

            if (!apiKey) {
                const key = prompt('Enter your Groq API key:\n\nGet one free at: https://console.groq.com/keys');
                if (key && key.trim()) {
                    localStorage.setItem('groq_api_key', key.trim());
                } else {
                    return;
                }
            }

            // Get loaded JSON entries
            const entriesData = localStorage.getItem('diaryEntries');
            if (!entriesData) {
                alert('No JSON data loaded. Please load a JSON file first.');
                return;
            }

            const entries = JSON.parse(entriesData);

            // Change button text to show processing
            const aiBtn = document.getElementById('ai-btn');
            const originalText = aiBtn.textContent;
            aiBtn.textContent = 'ANALYZING...';
            aiBtn.disabled = true;

            try {
                // Call Groq API
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('groq_api_key')}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: [
                            {
                                role: 'system',
                                content: 'Analyze the provided JSON entries by extracting trends, concepts, and ideas in a concise manner, maximum 60 words. Format as: "Trends: [brief list]. Concepts: [brief list]. Ideas: [brief list]." Do not include thinking process, full reports, or extraneous content. For example, for entries about arriving in Paris at the Eiffel Tower and in Astoria seeing and approving pizza, output: "Trends: food. Concepts: visit to Eiffel Tower and pizza in the US. Ideas: food across the ocean, pizza is key."'
                            },
                            {
                                role: 'user',
                                content: JSON.stringify(entries)
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                const analysis = data.choices[0]?.message?.content;

                if (!analysis) {
                    throw new Error('No response from API');
                }

                // Display result in modal
                const modal = document.getElementById('ai-analysis-modal');
                const content = document.getElementById('ai-analysis-content');
                const overlay = document.getElementById('form-overlay');

                content.textContent = analysis;
                modal.style.display = 'block';
                overlay.style.display = 'block';

            } catch (error) {
                console.error('AI analysis error:', error);
                alert('Error: ' + error.message + '\n\nPlease check your API key and try again.');
            } finally {
                // Reset button
                aiBtn.textContent = originalText;
                aiBtn.disabled = false;
            }
        });
    </script>
</body>

</html>